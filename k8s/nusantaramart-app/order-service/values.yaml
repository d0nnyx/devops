# ============================================
# Global Configuration
# ============================================

global:
  environment: production
  region: jakarta
  
image:
  repository: ghcr.io/nusantaramart/order-service
  pullPolicy: IfNotPresent
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# ============================================
# Deployment Configuration (Blue-Green)
# ============================================

deployment:
  # Blue or Green
  color: blue
  
  # Replica configuration
  replicaCount: 6
  
  # Rolling update strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  # Pod annotations
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/metrics"
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "nusantaramart-app"
    vault.hashicorp.com/agent-inject-secret-config: "secret/data/nusantaramart/order-service"
  
  # Pod labels
  labels:
    app: order-service
    tier: application
  
  # Security Context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  
  # Container Security Context
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL
      add:
        - NET_BIND_SERVICE

# ============================================
# Service Configuration
# ============================================

service:
  type: ClusterIP
  port: 80
  targetPort: 8080
  
  # Service selector - will be updated based on active color
  selector:
    app: order-service
    version: blue  # or green
  
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"

# ============================================
# Ingress Configuration
# ============================================

ingress:
  enabled: true
  className: "nginx"
  
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    
    # Blue-Green traffic splitting (managed externally)
    nginx.ingress.kubernetes.io/canary: "false"
  
  hosts:
    - host: api.nusantaramart.com
      paths:
        - path: /api/v1/orders
          pathType: Prefix
  
  tls:
    - secretName: nusantaramart-tls
      hosts:
        - api.nusantaramart.com

# ============================================
# Resources
# ============================================

resources:
  limits:
    cpu: 4000m
    memory: 8Gi
  requests:
    cpu: 2000m
    memory: 4Gi

# ============================================
# Autoscaling (HPA)
# ============================================

autoscaling:
  enabled: true
  minReplicas: 4
  maxReplicas: 20
  
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    
    - type: Pods
      pods:
        metric:
          name: http_requests_per_second
        target:
          type: AverageValue
          averageValue: "1000"

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 4
          periodSeconds: 30
      selectPolicy: Max

# ============================================
# Pod Disruption Budget
# ============================================

podDisruptionBudget:
  enabled: true
  minAvailable: 2
  # OR
  # maxUnavailable: 1

# ============================================
# Health Checks
# ============================================

livenessProbe:
  httpGet:
    path: /health/live
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

readinessProbe:
  httpGet:
    path: /health/ready
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 2
  successThreshold: 1

startupProbe:
  httpGet:
    path: /health/startup
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 30  # 5 minutes max startup

# ============================================
# Environment Variables
# ============================================

env:
  - name: NODE_ENV
    value: "production"
  
  - name: PORT
    value: "8080"
  
  - name: LOG_LEVEL
    value: "info"
  
  - name: DATABASE_HOST
    valueFrom:
      secretKeyRef:
        name: database-secret
        key: host
  
  - name: DATABASE_PORT
    value: "5432"
  
  - name: REDIS_HOST
    valueFrom:
      secretKeyRef:
        name: redis-secret
        key: host
  
  - name: OTEL_EXPORTER_OTLP_ENDPOINT
    value: "http://otel-collector:4317"
  
  - name: OTEL_SERVICE_NAME
    value: "order-service"
  
  - name: OTEL_RESOURCE_ATTRIBUTES
    value: "deployment.environment=production,service.version={{ .Values.image.tag }}"

# ============================================
# Volume Mounts
# ============================================

volumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: cache
    mountPath: /app/cache

volumes:
  - name: tmp
    emptyDir: {}
  - name: cache
    emptyDir: {}

# ============================================
# Node Selection & Affinity
# ============================================

nodeSelector:
  workload: high-performance

tolerations:
  - key: "high-performance"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

affinity:
  # Pod Anti-Affinity: Spread pods across nodes
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - order-service
          topologyKey: kubernetes.io/hostname
      
      - weight: 50
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - order-service
          topologyKey: topology.kubernetes.io/zone
  
  # Node Affinity: Prefer specific instance types
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: node.kubernetes.io/instance-type
              operator: In
              values:
                - c6i.4xlarge
                - c6i.2xlarge

# ============================================
# Service Account
# ============================================

serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/nusantaramart-order-service"
  name: "order-service-sa"

# ============================================
# Monitoring (ServiceMonitor for Prometheus)
# ============================================

serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: prometheus
  
  relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      targetLabel: node

# ============================================
# ConfigMap
# ============================================

configMap:
  enabled: true
  data:
    app-config.json: |
      {
        "server": {
          "port": 8080,
          "timeout": 30000
        },
        "cache": {
          "ttl": 3600,
          "maxSize": 1000
        },
        "rateLimit": {
          "windowMs": 60000,
          "max": 100
        }
      }

# ============================================
# Secrets (Example - Use External Secrets Operator in production)
# ============================================

secrets:
  enabled: false
  # Use Vault instead via annotations

# ============================================
# Network Policy
# ============================================

networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
  
  egress:
    - to:
      - namespaceSelector:
          matchLabels:
            name: database
      ports:
        - protocol: TCP
          port: 5432
    
    - to:
      - namespaceSelector:
          matchLabels:
            name: cache
      ports:
        - protocol: TCP
          port: 6379
    
    # Allow DNS
    - to:
      - namespaceSelector:
          matchLabels:
            name: kube-system
      ports:
        - protocol: UDP
          port: 53